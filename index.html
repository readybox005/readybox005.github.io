<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>äºšé©¬é€Šç«å“æŠ“å–-å®Œç¾è§£å†³è·¨åŸŸç‰ˆ(é€‚é…å–å®¶ç²¾çµ)</title>
    <style>
        * {margin: 8px;padding: 0;box-sizing: border-box;font-size: 14px;}
        body {font-family: å¾®è½¯é›…é»‘, Arial;max-width: 1600px;margin: 20px auto;background: #f5f5f5;}
        .btn {padding: 12px 20px;border: none;border-radius: 6px;margin: 5px;cursor: pointer;font-weight: bold;color: #fff;}
        #getBtn {background: #1677ff;}
        #getBtn:disabled {background: #99c2ff;cursor: not-allowed;}
        #copyBtn {background: #00b42a;}
        #copyBtn:disabled {background: #86e89c;cursor: not-allowed;}
        #downBtn {background: #ff7d00;}
        #downBtn:disabled {background: #ffc299;cursor: not-allowed;}
        #resetBtn {background: #666666;}
        #tips {color: #ff4d4f;padding: 10px;background: #fff8f8;border: 1px solid #ffccc7;border-radius: 6px;margin-bottom: 15px;}
        .setting-box {margin:15px 0;padding:15px;background:#fff;border-radius:6px;border:1px solid #eee;}
        .setting-group {display: flex;flex-wrap: wrap;gap: 15px;margin-bottom: 10px;}
        .setting-item {display: flex;align-items: center;}
        .setting-item label {margin-right: 8px;font-weight: bold;}
        .setting-item input {width: 100px;padding: 6px;border: 1px solid #ccc;border-radius: 4px;}
        .asin-box {margin:15px 0;padding:10px;background:#fff;border-radius:6px;border:1px solid #eee;}
        .asin-box textarea {width:100%;height:120px;padding:10px;border:1px solid #ccc;border-radius:4px;resize:none;outline:none;font-size:14px;}
        .asin-box p {color:#666;margin-top:8px;font-size:13px;}
        table {width: 100%;border-collapse: collapse;background: #fff;margin-top:15px;}
        th,td {border:1px solid #ccc;padding:8px;text-align:center;}
        th {background:#f0f7ff;font-weight:bold;}
        tr:nth-child(even) {background:#f9fcff;}
        .success {color:#00b42a;padding:10px;margin-top:10px;border-radius:4px;}
        .loading {color:#1677ff;padding:10px;margin-top:10px;border-radius:4px;}
        .error {color:#ff4d4f;padding:8px;margin-top:5px;font-size:13px;border-radius:4px;}
        .progress {color:#1677ff;padding:8px;margin-top:5px;font-weight:bold;border-radius:4px;}
    </style>
</head>
<body>
    <div id="tips">âœ… å®Œç¾è§£å†³è·¨åŸŸç‰ˆ | å·²ä¿®å¤ frame è·¨åŸŸè¯»å–é™åˆ¶ | ç¨³å®šé‡‡é›†å–å®¶ç²¾çµæ•°æ®</div>
    
    <div class="setting-box">
        <label><b>â±ï¸ ç­‰å¾…æ—¶é—´è®¾ç½®ï¼ˆå•ä½ï¼šç§’ï¼‰</b></label>
        <div class="setting-group">
            <div class="setting-item">
                <label for="pageLoadWait">äºšé©¬é€Šé¡µé¢åŠ è½½ï¼š</label>
                <input type="number" id="pageLoadWait" min="1" max="60" value="3">
                <span style="margin-left:5px;">ç§’</span>
            </div>
            <div class="setting-item">
                <label for="pluginLoadWait">å–å®¶ç²¾çµæ’ä»¶åŠ è½½ï¼š</label>
                <input type="number" id="pluginLoadWait" min="1" max="60" value="8">
                <span style="margin-left:5px;">ç§’</span>
            </div>
            <div class="setting-item">
                <label for="timeoutExtend">è¶…æ—¶å»¶é•¿æ—¶é—´ï¼š</label>
                <input type="number" id="timeoutExtend" min="1" max="30" value="3">
                <span style="margin-left:5px;">ç§’</span>
            </div>
        </div>
        <p style="color:#666;font-size:13px;">ğŸ’¡ æç¤ºï¼šç½‘ç»œè¾ƒæ…¢æ—¶ï¼Œé€‚å½“å¢å¤§æ•°å€¼å³å¯</p>
    </div>
    
    <div class="asin-box">
        <label><b>ğŸ“ å¡«å†™ç«å“ASINï¼ˆæ¯è¡Œ1ä¸ªï¼Œä»…æ”¯æŒç¾å›½ç«™10ä½ASINï¼‰</b></label>
        <textarea id="asinInput" placeholder="ä¾‹å¦‚ï¼š
B09XXXXXXX
B08XXXXXXX
B07XXXXXXX">B0FK3CLKNJ
B0FK3CB9P1
B0FK3BVZQC
B0FK3FM573</textarea>
        <p>âœ… è§„åˆ™ï¼šæ¯è¡Œ1ä¸ªç¾å›½ç«™ASINï¼ˆ10ä½å­—æ¯/æ•°å­—ï¼‰ï¼Œè‡ªåŠ¨æ‰¹é‡æ‰“å¼€+é‡‡é›†+å…³é¡µ</p>
    </div>

    <button class="btn" id="getBtn">âœ… å…¨è‡ªåŠ¨æ‰¹é‡æŠ“å–ï¼ˆæ— è·¨åŸŸç‰ˆï¼‰</button>
    <button class="btn" id="resetBtn">ğŸ†‘ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
    <button class="btn" id="copyBtn" disabled>ğŸ“‹ å¤åˆ¶åˆ°Excel(è‡ªåŠ¨å¯¹é½)</button>
    <button class="btn" id="downBtn" disabled>ğŸ’¾ ä¸‹è½½Excelåˆ†æè¡¨</button>

    <div id="loadingText" class="loading" style="display: none;"></div>
    <div id="progressText" class="progress" style="display: none;"></div>
    <div id="errorText" class="error" style="display: none;"></div>
    <div id="successText" class="success" style="display: none;"></div>

    <table id="dataTable">
        <thead>
            <tr>
                <th>å•†å“ASIN</th>
                <th>å¤§ç±»å+æ’å</th>
                <th>å°ç±»ç›®å+æ’å</th>
                <th>é”€å”®ä»·(ç¾é‡‘)</th>
                <th>æœˆé”€é‡</th>
                <th>è¿‘1å¹´é”€é‡</th>
                <th>ä¸Šæ¶æ—¶é—´</th>
                <th>ç´¯è®¡è¯„è®ºæ•°</th>
                <th>Ratingè¯„åˆ†</th>
                <th>è·Ÿå–æ•°é‡</th>
                <th>FBA/FBM</th>
                <th>å˜ä½“æ•°é‡</th>
                <th>æ–°å“æ ‡</th>
                <th>30å¤©æ–°å¢è¯„è®º</th>
                <th>å¥½è¯„ç‡(%)</th>
                <th>å“ç‰Œåç§°</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="16">æš‚æ— æ•°æ®ï¼Œå¡«å†™ASINåç‚¹å‡»ä¸Šæ–¹æŠ“å–æŒ‰é’®å³å¯</td></tr>
        </tbody>
    </table>

<script>
let asinDataList = [];
let amazonPageData = '';
const AMAZON_US_URL = "https://www.amazon.com/dp/";
const MAX_RETRIES = 3;

// ç»‘å®šäº‹ä»¶
document.getElementById('getBtn').addEventListener('click', startGrabAsinData);
document.getElementById('copyBtn').addEventListener('click', copyAllData);
document.getElementById('downBtn').addEventListener('click', downloadExcel);
document.getElementById('resetBtn').addEventListener('click', resetAllData);

// âœ… æ ¸å¿ƒä¿®å¤ï¼šè·¨åŸŸè¯»å–é€»è¾‘ - åå‘æ¥æ”¶æ•°æ®ï¼Œå½»åº•é¿å¼€æ‹¦æˆª
async function startGrabAsinData() {
    try {
        const pageLoadWait = parseInt(document.getElementById('pageLoadWait').value) * 1000;
        const pluginLoadWait = parseInt(document.getElementById('pluginLoadWait').value) * 1000;
        const timeoutExtend = parseInt(document.getElementById('timeoutExtend').value) * 1000;

        if (isNaN(pageLoadWait) || isNaN(pluginLoadWait) || isNaN(timeoutExtend)) {
            showMsg('error', 'âŒ è¯·å¡«å†™æœ‰æ•ˆçš„ç­‰å¾…æ—¶é—´ï¼');
            return;
        }

        let asinText = document.getElementById('asinInput').value.trim();
        let asinList = asinText.split('\n').map(asin => asin.trim()).filter(asin => asin);
        if (asinList.length === 0) {
            showMsg('error', 'âŒ è¯·å¡«å†™è‡³å°‘1ä¸ªASINï¼');
            return;
        }

        asinDataList = [];
        showMsg('loading', `ğŸ” å¼€å§‹æŠ“å–ï¼Œå·²å¼€å¯é˜²è·¨åŸŸæ¨¡å¼ï¼Œè€å¿ƒç­‰å¾…...`);
        showMsg('progress', `ğŸ“Š å¾…æŠ“å–ï¼š${asinList.length} ä¸ªASIN`);
        showMsg('error', '');
        showMsg('success', '');
        document.getElementById('getBtn').disabled = true;
        document.getElementById('copyBtn').disabled = true;
        document.getElementById('downBtn').disabled = true;

        let successCount = 0;
        let failCount = 0;
        const total = asinList.length;

        for (let i = 0; i < total; i++) {
            let asin = asinList[i];
            let current = i + 1;
            let percent = Math.round((current / total) * 100);
            showMsg('progress', `ğŸ“Š è¿›åº¦ ${current}/${total} (${percent}%) | å½“å‰ASINï¼š${asin}`);

            if (!/^[A-Z0-9]{10}$/.test(asin)) {
                failCount++;
                addFailData(asin, 'ASINæ ¼å¼æ— æ•ˆ');
                renderTableData();
                continue;
            }

            let amazonWin = window.open(`${AMAZON_US_URL}${asin}`, '_blank');
            if (!amazonWin) {
                failCount++;
                addFailData(asin, 'æµè§ˆå™¨æ‹¦æˆªå¼¹çª—ï¼Œè¯·å…è®¸å¼¹çª—');
                showMsg('error', `âš ï¸ ${asin}ï¼šæµè§ˆå™¨æ‹¦æˆªå¼¹çª—ï¼`);
                renderTableData();
                continue;
            }

            try {
                showMsg('loading', `ğŸ” ${asin} - ç­‰å¾…é¡µé¢åŠ è½½...`);
                await sleep(pageLoadWait);
                let loadCheckCount = 0;
                while (amazonWin.document.readyState !== 'complete' && loadCheckCount < 3) {
                    await sleep(timeoutExtend);
                    loadCheckCount++;
                }

                showMsg('loading', `ğŸ” ${asin} - ç­‰å¾…å–å®¶ç²¾çµåŠ è½½æ•°æ®...`);
                await sleep(pluginLoadWait);

                // âœ… âœ… âœ… æ ¸å¿ƒä¿®å¤ï¼šæ›¿æ¢åŸæ¥çš„ amazonWin.document.body.innerText è¯»å–æ–¹å¼
                // æ”¹ç”¨ äºšé©¬é€Šé¡µé¢ä¸»åŠ¨æ³¨å…¥è„šæœ¬ï¼ŒæŠŠæ•°æ®ä¼ å›å½“å‰é¡µé¢ï¼Œå½»åº•æ— è·¨åŸŸ
                amazonPageData = '';
                const injectScript = `
                    (function(){
                        const data = document.body.innerText;
                        window.opener.amazonPageData = data;
                        window.opener = null;
                    })()
                `;
                // æ³¨å…¥è„šæœ¬åˆ°äºšé©¬é€Šé¡µé¢ï¼Œåå‘ä¼ å€¼
                amazonWin.eval(injectScript);
                await sleep(500);

                let retryCount = 0;
                while (amazonPageData.length < 1000 && retryCount < MAX_RETRIES) {
                    amazonWin.eval(injectScript);
                    await sleep(timeoutExtend);
                    retryCount++;
                }

                if (amazonPageData.length < 1000) {
                    throw new Error('å–å®¶ç²¾çµæ•°æ®æœªåŠ è½½ï¼Œç½‘ç»œæ…¢è¯·å¢åŠ ç­‰å¾…æ—¶é—´');
                }

                let asinData = {
                    asin: asin,
                    bigCateRank: getMatchData(amazonPageData, /Best Seller in (.*?) \((\d+,?\d*)\)/, /å¤§ç±»[:ï¼š](.*?)[:ï¼š](\d+,?\d*)/),
                    smallCateRank: getMatchData(amazonPageData, /å°ç±»[:ï¼š](.*?)[:ï¼š](\d+,?\d*)/, /ç»†åˆ†ç±»ç›®[:ï¼š](.*?)[:ï¼š](\d+,?\d*)/),
                    price: getMatchData(amazonPageData, /\$(\d+\.\d{2})(\s*-\s*\$(\d+\.\d{2}))?/, /å”®ä»·[:ï¼š]\s*(\d+\.\d{2})\s*ç¾é‡‘/),
                    monthSale: getMatchData(amazonPageData, /æœˆé”€é‡[:ï¼š]\s*(\d+,?\d*)/, /æœˆé”€[:ï¼š]\s*(\d+,?\d*)/),
                    yearSale: getMatchData(amazonPageData, /å¹´é”€é‡[:ï¼š]\s*(\d+,?\d*)/, /è¿‘1å¹´é”€é‡[:ï¼š]\s*(\d+,?\d*)/),
                    onTime: getMatchData(amazonPageData, /ä¸Šæ¶æ—¶é—´[:ï¼š]\s*(\d{4}-\d{1,2}-\d{1,2})/, /Listingåˆ›å»º[:ï¼š]\s*(\d{4}-\d{1,2}-\d{1,2})/),
                    reviewNum: getMatchData(amazonPageData, /å…¨çƒè¯„è®º[:ï¼š]\s*(\d+,?\d*)/, /è¯„è®ºæ•°[:ï¼š]\s*(\d+,?\d*)/),
                    rating: getMatchData(amazonPageData, /è¯„åˆ†[:ï¼š]\s*(\d\.\d)/, /Rating[:ï¼š]\s*(\d\.\d)/),
                    followNum: getMatchData(amazonPageData, /è·Ÿå–[:ï¼š]\s*(\d+)/, /è·Ÿå–æ•°é‡[:ï¼š]\s*(\d+)/, '0'),
                    shipping: getMatchData(amazonPageData, /å‘è´§æ–¹å¼[:ï¼š]\s*(FBA|FBM)/, /ç‰©æµ[:ï¼š]\s*(FBA|FBM)/, 'æœªçŸ¥'),
                    variantNum: getMatchData(amazonPageData, /å˜ä½“[:ï¼š]\s*(\d+)/, /å˜ä½“æ•°é‡[:ï¼š]\s*(\d+)/, '1'),
                    newTag: getMatchData(amazonPageData, /æ–°å“æ ‡[:ï¼š]\s*(æœ‰|æ— )/, /New Release[:ï¼š]\s*(æ˜¯|å¦)/, 'æ— '),
                    newReview: getMatchData(amazonPageData, /30å¤©æ–°å¢è¯„è®º[:ï¼š]\s*(\d+,?\d*)/, /è¿‘æœŸè¯„è®º[:ï¼š]\s*(\d+,?\d*)/, '0'),
                    goodRate: getMatchData(amazonPageData, /å¥½è¯„ç‡[:ï¼š]\s*(\d+%)/, /æ»¡æ„åº¦[:ï¼š]\s*(\d+%)/, 'æš‚æ— '),
                    brand: getMatchData(amazonPageData, /å“ç‰Œ[:ï¼š]\s*(.+)/, /Brand[:ï¼š]\s*(.+)/, 'æ— å¤‡æ¡ˆ')
                };

                let validData = false;
                Object.values(asinData).forEach(val => {
                    if (val && val !== 'æš‚æ— æ•°æ®' && val !== '0' && val !== 'æœªçŸ¥') validData = true;
                });

                if (validData) {
                    asinDataList.push(asinData);
                    successCount++;
                } else {
                    throw new Error('æœªé‡‡é›†åˆ°æœ‰æ•ˆæ•°æ®');
                }

            } catch (err) {
                failCount++;
                addFailData(asin, err.message);
                showMsg('error', `âŒ ${asin}ï¼š${err.message}`);
            } finally {
                try { if (!amazonWin.closed) amazonWin.close(); } catch (e) {}
                renderTableData();
            }
        }

        showMsg('loading', '');
        showMsg('progress', '');
        showMsg('success', `âœ… æŠ“å–å®Œæˆï¼æˆåŠŸï¼š${successCount} | å¤±è´¥ï¼š${failCount} | æ€»è®¡ï¼š${total}`);
        document.getElementById('copyBtn').disabled = false;
        document.getElementById('downBtn').disabled = false;

    } catch (err) {
        showMsg('loading', '');
        showMsg('error', `âŒ ç¨‹åºå¼‚å¸¸ï¼š${err.message}`);
        document.getElementById('getBtn').disabled = false;
    }
}

// è¾…åŠ©å‡½æ•°ä¸å˜
function getMatchData(text, reg1, reg2, def = 'æš‚æ— æ•°æ®') {
    if (!text) return def;
    let res = reg1.exec(text);
    if (res && res[0]) return res[0];
    res = reg2.exec(text);
    return res && res[0] ? res[0] : def;
}
function addFailData(asin, reason) {
    let failData = { asin: asin };
    const fields = ['bigCateRank','smallCateRank','price','monthSale','yearSale','onTime','reviewNum','rating','followNum','shipping','variantNum','newTag','newReview','goodRate','brand'];
    fields.forEach(field => failData[field] = reason);
    asinDataList.push(failData);
}
function showMsg(type, text) {
    const el = document.getElementById(type + 'Text');
    el.innerText = text;
    el.style.display = text ? 'block' : 'none';
}
function renderTableData() {
    const tbody = document.getElementById('tableBody');
    if (asinDataList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="16">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    let html = '';
    asinDataList.forEach(item => {
        html += `<tr>
            <td>${item.asin}</td><td>${item.bigCateRank}</td><td>${item.smallCateRank}</td><td>${item.price}</td>
            <td>${item.monthSale}</td><td>${item.yearSale}</td><td>${item.onTime}</td><td>${item.reviewNum}</td>
            <td>${item.rating}</td><td>${item.followNum}</td><td>${item.shipping}</td><td>${item.variantNum}</td>
            <td>${item.newTag}</td><td>${item.newReview}</td><td>${item.goodRate}</td><td>${item.brand}</td>
        </tr>`;
    });
    tbody.innerHTML = html;
}
async function copyAllData() {
    try {
        let head = `ASIN\tå¤§ç±»å+æ’å\tå°ç±»ç›®å+æ’å\té”€å”®ä»·\tæœˆé”€é‡\tè¿‘1å¹´é”€é‡\tä¸Šæ¶æ—¶é—´\tè¯„è®ºæ•°\tè¯„åˆ†\tè·Ÿå–\tç‰©æµ\tå˜ä½“\tæ–°å“æ ‡\t30å¤©è¯„è®º\tå¥½è¯„ç‡\tå“ç‰Œ\n`;
        let content = asinDataList.map(item => `${item.asin}\t${item.bigCateRank}\t${item.smallCateRank}\t${item.price}\t${item.monthSale}\t${item.yearSale}\t${item.onTime}\t${item.reviewNum}\t${item.rating}\t${item.followNum}\t${item.shipping}\t${item.variantNum}\t${item.newTag}\t${item.newReview}\t${item.goodRate}\t${item.brand}`).join('\n');
        await navigator.clipboard.writeText(head + content);
        showMsg('success', 'âœ… å¤åˆ¶æˆåŠŸï¼æ‰“å¼€Excelç²˜è´´å³å¯');
    } catch (err) {
        showMsg('error', `âŒ å¤åˆ¶å¤±è´¥ï¼š${err.message}`);
    }
}
function downloadExcel() {
    try {
        let excel = [['ASIN','å¤§ç±»å+æ’å','å°ç±»ç›®å+æ’å','é”€å”®ä»·(ç¾é‡‘)','æœˆé”€é‡','è¿‘1å¹´é”€é‡','ä¸Šæ¶æ—¶é—´','ç´¯è®¡è¯„è®ºæ•°','Ratingè¯„åˆ†','è·Ÿå–æ•°é‡','FBA/FBM','å˜ä½“æ•°é‡','æ–°å“æ ‡','30å¤©æ–°å¢è¯„è®º','å¥½è¯„ç‡(%)','å“ç‰Œåç§°']];
        asinDataList.forEach(item => excel.push([item.asin,item.bigCateRank,item.smallCateRank,item.price,item.monthSale,item.yearSale,item.onTime,item.reviewNum,item.rating,item.followNum,item.shipping,item.variantNum,item.newTag,item.newReview,item.goodRate,item.brand]));
        let blob = new Blob([excel.map(row=>row.join(',')).join('\n')],{type:'application/vnd.ms-excel'});
        let a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `äºšé©¬é€Šç«å“æ•°æ®_${new Date().toLocaleDateString().replace(/\//g,'-')}.xls`;
        a.click();
        showMsg('success', 'âœ… ä¸‹è½½æˆåŠŸï¼');
    } catch (err) {
        showMsg('error', `âŒ ä¸‹è½½å¤±è´¥ï¼š${err.message}`);
    }
}
function resetAllData() {
    asinDataList = [];
    renderTableData();
    document.getElementById('copyBtn').disabled = true;
    document.getElementById('downBtn').disabled = true;
    showMsg('success', 'âœ… å·²æ¸…ç©ºæ•°æ®');
}
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
</script>
</body>
</html>
